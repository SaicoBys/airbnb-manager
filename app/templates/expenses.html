{% extends "base.html" %}

{% block content %}
    <div class="page-header">
        <h1>💸 Registro de Gastos</h1>
        <a href="{{ url_for('main.add_expense') }}" class="btn btn-primary">Añadir Nuevo Gasto</a>
    </div>

    <!-- Resumen de gastos por método de pago -->
    {% if expenses %}
        <div class="expense-summary">
            {% set employee_expenses = expenses | selectattr('affects_cash_closure') | list %}
            {% set owner_expenses = expenses | rejectattr('affects_cash_closure') | list %}
            
            <div class="summary-card employee-expenses">
                <h3>👩‍💼 Gastos de Empleada</h3>
                <div class="amount">{{ employee_expenses | length }}</div>
                <div class="total">DOP {{ "{:,.2f}".format(employee_expenses | sum(attribute='amount')) }}</div>
                <small>Afectan el cuadre de caja</small>
            </div>
            
            <div class="summary-card owner-expenses">
                <h3>👩‍💼 Gastos de Propietarios</h3>
                <div class="amount">{{ owner_expenses | length }}</div>
                <div class="total">DOP {{ "{:,.2f}".format(owner_expenses | sum(attribute='amount')) }}</div>
                <small>No afectan el cuadre</small>
            </div>
            
            <div class="summary-card total-expenses">
                <h3>📊 Total General</h3>
                <div class="amount">{{ expenses | length }}</div>
                <div class="total">DOP {{ "{:,.2f}".format(expenses | sum(attribute='amount')) }}</div>
                <small>Todos los gastos</small>
            </div>
        </div>

        <table class="expenses-table">
            <thead>
                <tr>
                    <th>Fecha</th>
                    <th>Descripción</th>
                    <th>Categoría</th>
                    <th>Monto</th>
                    <th>Método de Pago</th>
                    <th>Pagado por</th>
                    <th>Impacto Caja</th>
                </tr>
            </thead>
            <tbody>
                {% for expense in expenses %}
                <tr class="expense-row {% if expense.affects_cash_closure() %}employee-expense{% else %}owner-expense{% endif %}">
                    <td>{{ expense.expense_date.strftime('%d-%m-%Y') }}</td>
                    <td>
                        <strong>{{ expense.description }}</strong>
                    </td>
                    <td>
                        <span class="category-badge">{{ expense.category }}</span>
                    </td>
                    <td class="money-cell">
                        <span class="money-amount">DOP {{ "{:,.2f}".format(expense.amount) }}</span>
                    </td>
                    <td class="payment-method">
                        {{ expense.get_payment_method_display() }}
                    </td>
                    <td class="paid-by">
                        {% if expense.paid_by %}
                            <strong>{{ expense.get_paid_by_display() }}</strong>
                        {% else %}
                            <span class="text-muted">No especificado</span>
                        {% endif %}
                    </td>
                    <td class="cash-impact">
                        {% if expense.affects_cash_closure() %}
                            <span class="impact-badge affects">⚠️ Afecta Caja</span>
                        {% else %}
                            <span class="impact-badge no-affect">✅ No Afecta</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    {% else %}
        <div class="empty-state">
            <h3>📋 No hay gastos registrados</h3>
            <p>Comienza registrando el primer gasto del negocio.</p>
            <a href="{{ url_for('main.add_expense') }}" class="btn btn-primary">Registrar Primer Gasto</a>
        </div>
    {% endif %}

{% endblock %}
